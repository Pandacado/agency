import React, { useState, useEffect } from 'react';
import axios from 'axios';
import toast from 'react-hot-toast';
import { useForm } from 'react-hook-form';
import {
  CheckSquare, Square, Clock, AlertCircle, User,
  Building2, Calendar, Brain, Zap, Plus, X, Target, ChevronDown
} from 'lucide-react';

// Interface TanÄ±mlamalarÄ±
interface Task {
  id: number;
  customer_id: number;
  title: string;
  description: string;
  priority: 'low' | 'medium' | 'high';
  status: 'pending' | 'in_progress' | 'completed';
  due_date: string;
  created_by_ai: boolean;
  task_type: 'manual' | 'ai_generated';
  customer_name: string;
  company: string;
  created_at: string;
}

interface Customer {
  id: number;
  first_name: string;
  last_name: string;
  company: string;
}

interface TaskFormData {
  customer_id: number;
  title: string;
  description: string;
  priority: 'low' | 'medium' | 'high';
  due_date: string;
}

// GÃ¶rev ÅžablonlarÄ± (AÃ§Ä±klamalar Eklendi)
const taskTemplates = [
    {
      category: 'ðŸŸ£ Sosyal Medya YÃ¶netimi GÃ¶revleri',
      tasks: [
        { title: 'Meta Business bilgilerini iste', description: 'MÃ¼ÅŸteriden, Meta Business Manager hesabÄ±na eriÅŸim iÃ§in kullandÄ±ÄŸÄ± e-posta adresini talep et. EÄŸer hesabÄ± yoksa, kurulum iÃ§in yÃ¶nlendirme yap.' },
        { title: 'Instagram kullanÄ±cÄ± adÄ± ve ÅŸifresini iste', description: 'Ä°Ã§erik paylaÅŸÄ±mÄ± ve hesap yÃ¶netimi iÃ§in mÃ¼ÅŸterinin Instagram kullanÄ±cÄ± adÄ± ve ÅŸifresini gÃ¼venli bir ÅŸekilde talep et.' },
        { title: 'Meta reklam paneline eriÅŸim izni al', description: 'MÃ¼ÅŸterinin reklam hesabÄ±na, ajansÄ±n Business Manager\'Ä± Ã¼zerinden "Partner EriÅŸimi" talep et. MÃ¼ÅŸteriye kabul etmesi iÃ§in bildirim gidecektir.' },
        { title: 'Meta Business Managerâ€™a admin olarak eklen', description: 'MÃ¼ÅŸterinin mevcut Business Manager hesabÄ±na, ajans yetkilisini "YÃ¶netici" olarak eklemesini talep et.' },
        { title: 'Ä°Ã§erik onayÄ± iÃ§in Ã¶rnek gÃ¶nderi talep et', description: 'MÃ¼ÅŸterinin marka dilini ve beklentilerini anlamak iÃ§in daha Ã¶nce paylaÅŸtÄ±ÄŸÄ± veya beÄŸendiÄŸi Ã¶rnek gÃ¶nderileri iste.' },
        { title: 'PaylaÅŸÄ±m gÃ¼nleri ve saatlerini belirle', description: 'MÃ¼ÅŸteri ile hedef kitle analizine dayalÄ± olarak haftalÄ±k iÃ§erik paylaÅŸÄ±m takvimini (gÃ¼nler ve saatler) oluÅŸtur ve onaya sun.' },
        { title: 'Rakip analiz raporunu hazÄ±rla', description: 'SektÃ¶rdeki 3 ana rakibin sosyal medya stratejilerini, gÃ¼Ã§lÃ¼ ve zayÄ±f yÃ¶nlerini iÃ§eren bir analiz raporu hazÄ±rla.' },
        { title: 'Reels formatÄ±nda video iste', description: 'Sosyal medya paylaÅŸÄ±mlarÄ±nda kullanÄ±lmak Ã¼zere, mÃ¼ÅŸteriden Ã¼rÃ¼n/hizmetlerini tanÄ±tan kÄ±sa, dikey formatta videolar talep et.' },
        { title: 'Marka renk ve logo bilgilerini al', description: 'TÃ¼m tasarÄ±mlarda kullanÄ±lmak Ã¼zere mÃ¼ÅŸterinin kurumsal kimlik kÄ±lavuzunu veya en azÄ±ndan logo (vektÃ¶rel formatta) ve marka renk kodlarÄ±nÄ± (HEX/RGB) iste.' },
        { title: 'KullanÄ±lacak hashtag listesini oluÅŸtur', description: 'Marka, sektÃ¶r ve hedef kitleye uygun, etkileÅŸimi artÄ±racak 15-20 adetlik bir hashtag listesi oluÅŸtur ve mÃ¼ÅŸteri onayÄ±na sun.' },
      ],
    },
    {
      category: 'ðŸ”µ Reklam YÃ¶netimi (Meta & Google Ads)',
      tasks: [
        { title: 'Meta reklam yetkilendirmesi talep et', description: 'MÃ¼ÅŸterinin reklam hesabÄ±na, ajansÄ±n Business Manager ID\'si Ã¼zerinden "Partner EriÅŸimi" ile yetki talep et.' },
        { title: 'Hedef kitle ve bÃ¶lge bilgilerini al', description: 'ReklamlarÄ±n gÃ¶sterileceÄŸi demografik (yaÅŸ, cinsiyet), coÄŸrafi (ÅŸehir, bÃ¶lge) ve ilgi alanÄ± bazlÄ± hedef kitle bilgilerini mÃ¼ÅŸteriden Ã¶ÄŸren.' },
        { title: 'Google Ads yÃ¶neticisi olarak eriÅŸim al', description: 'MÃ¼ÅŸterinin Google Ads hesap numarasÄ±nÄ± (XXX-XXX-XXXX) talep et ve ajansÄ±n MCC (YÃ¶netici HesabÄ±) Ã¼zerinden eriÅŸim isteÄŸi gÃ¶nder.' },
        { title: 'Web sitesine dÃ¶nÃ¼ÅŸÃ¼m kodu eklenmesini iste', description: 'Reklam performansÄ±nÄ± Ã¶lÃ§mek iÃ§in Meta Pixel ve Google Ads DÃ¶nÃ¼ÅŸÃ¼m Ä°zleme kodlarÄ±nÄ±n web sitesinin tÃ¼m sayfalarÄ±na eklenmesini saÄŸla.' },
        { title: 'ÃœrÃ¼n veya hizmet fotoÄŸraflarÄ±nÄ± iste', description: 'Reklam gÃ¶rsellerinde kullanÄ±lmak Ã¼zere yÃ¼ksek Ã§Ã¶zÃ¼nÃ¼rlÃ¼klÃ¼ ve dikkat Ã§ekici Ã¼rÃ¼n/hizmet fotoÄŸraflarÄ±nÄ± mÃ¼ÅŸteriden talep et.' },
        { title: 'Reklam bÃ¼tÃ§esini ve sÃ¼resini belirle', description: 'MÃ¼ÅŸteri ile gÃ¶rÃ¼ÅŸerek aylÄ±k veya kampanya bazlÄ± toplam reklam bÃ¼tÃ§esini ve reklamlarÄ±n ne kadar sÃ¼re yayÄ±nda kalacaÄŸÄ±nÄ± netleÅŸtir.' },
        { title: 'Reklam metni onayÄ± al', description: 'HazÄ±rlanan reklam baÅŸlÄ±klarÄ± ve metinlerini, yayÄ±nlanmadan Ã¶nce mÃ¼ÅŸteri onayÄ±na sun.' },
        { title: 'DÃ¶nÃ¼ÅŸÃ¼m takibi iÃ§in form/WhatsApp linki al', description: 'Reklamlardan gelen potansiyel mÃ¼ÅŸterilerin yÃ¶nlendirileceÄŸi iletiÅŸim formu, WhatsApp hattÄ± veya landing page linkini mÃ¼ÅŸteriden al.' },
      ],
    },
    {
      category: 'ðŸŸ¢ Web Sitesi / E-Ticaret',
      tasks: [
        { title: 'Alan adÄ± ve hosting bilgilerini al', description: 'Web sitesinin yayÄ±nlanacaÄŸÄ± alan adÄ± (domain) ve hosting paneli (cPanel, Plesk vb.) eriÅŸim bilgilerini mÃ¼ÅŸteriden talep et.' },
        { title: 'Web sitesi istek formunu doldurt', description: 'MÃ¼ÅŸterinin beklentilerini, hedeflerini ve proje detaylarÄ±nÄ± anlamak iÃ§in hazÄ±rlanan detaylÄ± web sitesi istek formunu mÃ¼ÅŸteriye gÃ¶nder ve doldurmasÄ±nÄ± saÄŸla.' },
        { title: 'Gerekli sayfalar: HakkÄ±mÄ±zda, Ä°letiÅŸim, Hizmetler, Blog, Galeri', description: 'Web sitesinde yer almasÄ± gereken temel sayfalarÄ±n listesini mÃ¼ÅŸteri ile teyit et ve bu sayfalarÄ±n iÃ§eriklerini talep et.' },
        { title: 'Logo, renkler ve font tercihlerini iste', description: 'Web sitesi tasarÄ±mÄ±nda kullanÄ±lacak kurumsal kimlik elemanlarÄ±nÄ± (logo, renk kodlarÄ±, font isimleri) mÃ¼ÅŸteriden al.' },
        { title: 'Referans beÄŸendiÄŸi siteleri Ã¶ÄŸren', description: 'MÃ¼ÅŸterinin estetik anlayÄ±ÅŸÄ±nÄ± ve beklentilerini kavramak iÃ§in beÄŸendiÄŸi 3 adet referans web sitesi linkini iste.' },
        { title: 'ÃœrÃ¼n/hizmet detaylarÄ±nÄ± al', description: 'Sitede sergilenecek tÃ¼m Ã¼rÃ¼n veya hizmetlerin detaylÄ± aÃ§Ä±klamalarÄ±nÄ±, Ã¶zelliklerini ve fiyat bilgilerini iÃ§eren bir dokÃ¼man talep et.' },
        { title: 'Ã–deme altyapÄ±sÄ± tercihini Ã¶ÄŸren (iyzico, stripe, etc.)', description: 'E-ticaret sitesi iÃ§in kullanÄ±lacak sanal POS veya Ã¶deme kuruluÅŸu (Iyzico, PayTR, Stripe vb.) tercihini mÃ¼ÅŸteriden Ã¶ÄŸren.' },
        { title: 'Kargo ve iade politikasÄ± iste', description: 'Sitede yayÄ±nlanmak Ã¼zere, yasal zorunluluklarÄ± karÅŸÄ±layan kargo, iade ve gizlilik politikasÄ± metinlerini mÃ¼ÅŸteriden talep et.' },
        { title: 'Google Analytics / Search Console eriÅŸimi al', description: 'Sitenin performans takibi iÃ§in mÃ¼ÅŸterinin mevcut Google Analytics ve Search Console hesaplarÄ±na yÃ¶netici eriÅŸimi talep et.' },
        { title: 'Ä°Ã§erik ve gÃ¶rsel yÃ¼kleme klasÃ¶rÃ¼ oluÅŸtur', description: 'MÃ¼ÅŸterinin site iÃ§in gÃ¶ndereceÄŸi tÃ¼m metin ve gÃ¶rselleri toplayacaÄŸÄ± bir paylaÅŸÄ±mlÄ± bulut klasÃ¶rÃ¼ (Google Drive, Dropbox vb.) oluÅŸtur ve linkini paylaÅŸ.' },
      ],
    },
];

export const Tasks: React.FC = () => {
  const [tasks, setTasks] = useState<Task[]>([]);
  const [customers, setCustomers] = useState<Customer[]>([]);
  const [loading, setLoading] = useState(true);
  const [filter, setFilter] = useState<'all' | 'pending' | 'in_progress' | 'completed'>('all');
  const [taskTypeFilter, setTaskTypeFilter] = useState<'all' | 'manual' | 'ai_generated'>('all');
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [isMenuOpen, setIsMenuOpen] = useState(false);

  const { register, handleSubmit, formState: { errors }, reset } = useForm<TaskFormData>();

  useEffect(() => {
    fetchTasks();
    fetchCustomers();
  }, []);

  const fetchTasks = async () => {
    setLoading(true);
    try {
      const response = await axios.get('/api/tasks');
      setTasks(response.data);
    } catch (error) { toast.error('GÃ¶revler yÃ¼klenirken hata oluÅŸtu'); } finally { setLoading(false); }
  };

  const fetchCustomers = async () => {
    try {
      const response = await axios.get('/api/customers');
      setCustomers(response.data);
    } catch (error) { console.error('Customers fetch error:', error); }
  };

  const openModal = (title = '', description = '') => {
    reset({ title, description, priority: 'medium' });
    setIsModalOpen(true);
  };

  const closeModal = () => { setIsModalOpen(false); reset(); };

  const handleTemplateClick = (title: string, description: string) => {
    openModal(title, description);
    setIsMenuOpen(false);
  };

  const onSubmit = async (data: TaskFormData) => {
    try {
      const taskData = { ...data, task_type: 'manual' };
      await axios.post('/api/tasks', taskData);
      toast.success('GÃ¶rev eklendi', { icon: 'âœ…' });
      closeModal();
      fetchTasks();
    } catch (error: any) { toast.error(error.response?.data?.error || 'GÃ¶rev eklenirken hata oluÅŸtu'); }
  };

  const updateTaskStatus = async (taskId: number, status: Task['status']) => {
    try {
      const response = await axios.put(`/api/tasks/${taskId}`, { status });
      setTasks(prev => prev.map(t => t.id === taskId ? { ...t, status: response.data.status } : t));
      toast.success('GÃ¶rev durumu gÃ¼ncellendi');
    } catch (error) { toast.error('Durum gÃ¼ncellenirken hata oluÅŸtu'); }
  };

  const getPriorityColor = (priority: string) => {
    switch (priority) {
      case 'high': return 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200';
      case 'medium': return 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200';
      case 'low': return 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
      default: return 'bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-200';
    }
  };

  const getPriorityText = (priority: string) => {
    switch (priority) {
      case 'high': return 'YÃ¼ksek';
      case 'medium': return 'Orta';
      case 'low': return 'DÃ¼ÅŸÃ¼k';
      default: return priority;
    }
  };
  
  const getStatusText = (status: string) => {
    switch (status) {
      case 'pending': return 'Bekliyor';
      case 'in_progress': return 'Devam Ediyor';
      case 'completed': return 'TamamlandÄ±';
      default: return status;
    }
  };

  const filteredTasks = tasks.filter(task => {
    const statusMatch = filter === 'all' || task.status === filter;
    const typeMatch = taskTypeFilter === 'all' || task.task_type === taskTypeFilter;
    return statusMatch && typeMatch;
  });

  const pendingTasks = tasks.filter(t => t.status === 'pending').length;
  const inProgressTasks = tasks.filter(t => t.status === 'in_progress').length;
  const completedTasks = tasks.filter(t => t.status === 'completed').length;
  const manualTasks = tasks.filter(t => t.task_type === 'manual').length;
  const aiTasks = tasks.filter(t => t.task_type === 'ai_generated').length;

  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
      </div>
    );
  }

  return (
    <div className="space-y-8 font-poppins">
      <div className="relative animate-slide-up">
        <div className="absolute inset-0 bg-gradient-to-r from-emerald-600 via-blue-600 to-purple-600 rounded-3xl blur-3xl opacity-10"></div>
        <div className="relative modern-card p-8">
          <div className="sm:flex sm:items-center sm:justify-between">
            <div className="flex items-center space-x-6">
              <div className="p-4 bg-gradient-to-r from-emerald-500 to-blue-600 rounded-3xl shadow-lg animate-float">
                <CheckSquare className="h-10 w-10 text-white" />
              </div>
              <div>
                <h1 className="text-4xl font-bold bg-gradient-to-r from-emerald-600 to-blue-600 bg-clip-text text-transparent">
                  GÃ¶revler
                </h1>
                <p className="text-lg text-gray-600 dark:text-gray-300 mt-2 font-medium">
                  AI ve manuel gÃ¶revlerinizi takip edin
                </p>
              </div>
            </div>
            <div className="mt-6 sm:mt-0">
              <div className="relative inline-block text-left">
                <div>
                  <button
                    onClick={() => setIsMenuOpen(!isMenuOpen)}
                    className="modern-button-primary inline-flex items-center"
                  >
                    <Plus className="h-5 w-5 mr-3" />
                    Yeni GÃ¶rev Ekle
                    <ChevronDown className="w-5 h-5 ml-2 -mr-1" />
                  </button>
                </div>
                {isMenuOpen && (
                  <div className="absolute right-0 mt-2 w-80 origin-top-right divide-y divide-gray-100 dark:divide-gray-700 rounded-2xl bg-white dark:bg-gray-800 shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none z-10 animate-fade-in">
                    <div className="px-1 py-1">
                      <button
                        onClick={() => { openModal(); setIsMenuOpen(false); }}
                        className="text-gray-900 dark:text-gray-200 hover:bg-purple-500 hover:text-white group flex w-full items-center rounded-md px-2 py-3 text-sm font-semibold"
                      >
                        <Plus className="mr-3 h-5 w-5" />
                        BoÅŸ GÃ¶rev OluÅŸtur
                      </button>
                    </div>
                    {taskTemplates.map((group) => (
                      <div key={group.category} className="px-1 py-1">
                        <div className="px-3 py-2 text-xs font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                          {group.category}
                        </div>
                        {group.tasks.map((task) => (
                          <button
                            key={task.title}
                            onClick={() => handleTemplateClick(task.title, task.description)}
                            className="text-gray-900 dark:text-gray-200 hover:bg-purple-500 hover:text-white group flex w-full items-center rounded-md px-3 py-2 text-sm text-left"
                          >
                            {task.title}
                          </button>
                        ))}
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>

      <div className="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-5">
        <div className="modern-card p-6 animate-slide-up" style={{ animationDelay: '100ms' }}>
          <div className="flex items-center">
            <div className="flex-shrink-0"><Clock className="h-10 w-10 text-yellow-500" /></div>
            <div className="ml-5 w-0 flex-1"><dl><dt className="text-sm font-bold text-gray-500 dark:text-gray-400 truncate">Bekleyen</dt><dd className="text-2xl font-bold text-gray-900 dark:text-white">{pendingTasks}</dd></dl></div>
          </div>
        </div>
        <div className="modern-card p-6 animate-slide-up" style={{ animationDelay: '200ms' }}>
          <div className="flex items-center">
            <div className="flex-shrink-0"><Zap className="h-10 w-10 text-blue-500" /></div>
            <div className="ml-5 w-0 flex-1"><dl><dt className="text-sm font-bold text-gray-500 dark:text-gray-400 truncate">Devam Eden</dt><dd className="text-2xl font-bold text-gray-900 dark:text-white">{inProgressTasks}</dd></dl></div>
          </div>
        </div>
        <div className="modern-card p-6 animate-slide-up" style={{ animationDelay: '300ms' }}>
          <div className="flex items-center">
            <div className="flex-shrink-0"><CheckSquare className="h-10 w-10 text-green-500" /></div>
            <div className="ml-5 w-0 flex-1"><dl><dt className="text-sm font-bold text-gray-500 dark:text-gray-400 truncate">Tamamlanan</dt><dd className="text-2xl font-bold text-gray-900 dark:text-white">{completedTasks}</dd></dl></div>
          </div>
        </div>
        <div className="modern-card p-6 animate-slide-up" style={{ animationDelay: '400ms' }}>
          <div className="flex items-center">
            <div className="flex-shrink-0"><Target className="h-10 w-10 text-purple-500" /></div>
            <div className="ml-5 w-0 flex-1"><dl><dt className="text-sm font-bold text-gray-500 dark:text-gray-400 truncate">Manuel</dt><dd className="text-2xl font-bold text-gray-900 dark:text-white">{manualTasks}</dd></dl></div>
          </div>
        </div>
        <div className="modern-card p-6 animate-slide-up" style={{ animationDelay: '500ms' }}>
          <div className="flex items-center">
            <div className="flex-shrink-0"><Brain className="h-10 w-10 text-indigo-500" /></div>
            <div className="ml-5 w-0 flex-1"><dl><dt className="text-sm font-bold text-gray-500 dark:text-gray-400 truncate">AI Ã–nerisi</dt><dd className="text-2xl font-bold text-gray-900 dark:text-white">{aiTasks}</dd></dl></div>
          </div>
        </div>
      </div>
      
      <div className="modern-card animate-slide-up" style={{ animationDelay: '600ms' }}>
        <div className="border-b border-gray-200 dark:border-gray-700">
          <div className="flex flex-wrap gap-4 px-8 py-6">
            <div className="flex space-x-2">
              <span className="text-sm font-bold text-gray-700 dark:text-gray-300 py-2">Durum:</span>
              {[
                { key: 'all', label: 'TÃ¼mÃ¼', count: tasks.length },
                { key: 'pending', label: 'Bekleyen', count: pendingTasks },
                { key: 'in_progress', label: 'Devam Eden', count: inProgressTasks },
                { key: 'completed', label: 'Tamamlanan', count: completedTasks }
              ].map((tab) => (
                <button key={tab.key} onClick={() => setFilter(tab.key as any)} className={`${filter === tab.key ? 'bg-gradient-to-r from-blue-500 to-purple-600 text-white shadow-lg' : 'text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'} px-4 py-2 rounded-2xl font-semibold text-sm flex items-center transition-all duration-300 hover:scale-105`}>
                  {tab.label}
                  <span className={`${filter === tab.key ? 'bg-white bg-opacity-20 text-white' : 'bg-gray-100 text-gray-900 dark:bg-gray-700 dark:text-gray-300'} ml-2 py-1 px-2 rounded-full text-xs font-bold`}>{tab.count}</span>
                </button>
              ))}
            </div>
            <div className="flex space-x-2">
              <span className="text-sm font-bold text-gray-700 dark:text-gray-300 py-2">TÃ¼r:</span>
              {[
                { key: 'all', label: 'TÃ¼mÃ¼', count: tasks.length },
                { key: 'manual', label: 'Manuel', count: manualTasks },
                { key: 'ai_generated', label: 'AI Ã–nerisi', count: aiTasks }
              ].map((tab) => (
                <button key={tab.key} onClick={() => setTaskTypeFilter(tab.key as any)} className={`${taskTypeFilter === tab.key ? 'bg-gradient-to-r from-emerald-500 to-blue-600 text-white shadow-lg' : 'text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700'} px-4 py-2 rounded-2xl font-semibold text-sm flex items-center transition-all duration-300 hover:scale-105`}>
                  {tab.label}
                  <span className={`${taskTypeFilter === tab.key ? 'bg-white bg-opacity-20 text-white' : 'bg-gray-100 text-gray-900 dark:bg-gray-700 dark:text-gray-300'} ml-2 py-1 px-2 rounded-full text-xs font-bold`}>{tab.count}</span>
                </button>
              ))}
            </div>
          </div>
        </div>

        {filteredTasks.length === 0 ? (
          <div className="text-center py-16">
            <div className="w-24 h-24 bg-gradient-to-r from-emerald-500 to-blue-600 rounded-full flex items-center justify-center mx-auto mb-8 animate-float"><CheckSquare className="h-12 w-12 text-white" /></div>
            <h3 className="text-2xl font-bold text-gray-900 dark:text-white mb-3">{filter === 'all' && taskTypeFilter === 'all' ? 'HenÃ¼z gÃ¶rev yok' : 'Filtreye uygun gÃ¶rev bulunamadÄ±'}</h3>
            <p className="text-lg text-gray-500 dark:text-gray-400 mb-8">AI analiziyle otomatik gÃ¶revler oluÅŸturulacak veya manuel gÃ¶rev ekleyebilirsiniz</p>
            <button onClick={() => openModal()} className="modern-button-primary"><Plus className="h-5 w-5 mr-3" />Yeni GÃ¶rev</button>
          </div>
        ) : (
          <div className="divide-y divide-gray-200 dark:divide-gray-700">
            {filteredTasks.map((task, index) => (
              <div key={task.id} className="p-8 hover:bg-gray-50 dark:hover:bg-gray-700 transition-all duration-300 animate-slide-up" style={{ animationDelay: `${index * 50}ms` }}>
                <div className="flex items-start justify-between">
                  <div className="flex items-start space-x-4 flex-1">
                    <button onClick={() => { const newStatus = task.status === 'completed' ? 'pending' : task.status === 'pending' ? 'in_progress' : 'completed'; updateTaskStatus(task.id, newStatus); }} className="mt-2 text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-all duration-300 hover:scale-110">
                      {task.status === 'completed' ? <CheckSquare className="h-6 w-6 text-green-600 dark:text-green-400" /> : <Square className="h-6 w-6" />}
                    </button>
                    <div className="flex-1">
                      <div className="flex items-center space-x-3 mb-3">
                        <h3 className={`text-xl font-bold ${task.status === 'completed' ? 'line-through text-gray-500 dark:text-gray-400' : 'text-gray-900 dark:text-white'}`}>{task.title}</h3>
                        {task.task_type === 'ai_generated' && (<span className="inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-gradient-to-r from-purple-100 to-indigo-100 text-purple-800 dark:from-purple-900 dark:to-indigo-900 dark:text-purple-200"><Brain className="h-4 w-4 mr-2" />AI Ã–nerisi</span>)}
                        {task.task_type === 'manual' && (<span className="inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-gradient-to-r from-emerald-100 to-blue-100 text-emerald-800 dark:from-emerald-900 dark:to-blue-900 dark:text-emerald-200"><Target className="h-4 w-4 mr-2" />Manuel</span>)}
                        <span className={`inline-flex px-3 py-1 text-sm font-bold rounded-full ${getPriorityColor(task.priority)}`}>{getPriorityText(task.priority)}</span>
                      </div>
                      {task.description && (<p className="text-base text-gray-600 dark:text-gray-300 mb-4 font-medium">{task.description}</p>)}
                      <div className="flex items-center space-x-8 text-sm text-gray-500 dark:text-gray-400">
                        <div className="flex items-center font-semibold"><User className="h-4 w-4 mr-2" />{task.customer_name}</div>
                        {task.company && (<div className="flex items-center font-semibold"><Building2 className="h-4 w-4 mr-2" />{task.company}</div>)}
                        {task.due_date && (<div className="flex items-center font-semibold"><Calendar className="h-4 w-4 mr-2" />{new Date(task.due_date).toLocaleDateString('tr-TR')}</div>)}
                      </div>
                    </div>
                  </div>
                  <div className="flex flex-col items-end space-y-3">
                    <div className={`px-4 py-2 rounded-full text-sm font-bold ${task.status === 'completed' ? 'bg-gradient-to-r from-green-100 to-emerald-100 text-green-800 dark:from-green-900 dark:to-emerald-900 dark:text-green-200' : task.status === 'in_progress' ? 'bg-gradient-to-r from-blue-100 to-indigo-100 text-blue-800 dark:from-blue-900 dark:to-indigo-900 dark:text-blue-200' : 'bg-gradient-to-r from-gray-100 to-slate-100 text-gray-800 dark:from-gray-900 dark:to-slate-900 dark:text-gray-200'}`}>{getStatusText(task.status)}</div>
                    {task.due_date && new Date(task.due_date) < new Date() && task.status !== 'completed' && (<div className="flex items-center text-red-600 dark:text-red-400 font-bold"><AlertCircle className="h-4 w-4 mr-2" /><span className="text-sm">GecikmiÅŸ</span></div>)}
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>

      {isModalOpen && (
        <div className="fixed inset-0 z-50 overflow-y-auto bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center p-4">
          <div className="w-full max-w-2xl transform overflow-hidden rounded-3xl bg-white dark:bg-gray-800 p-8 text-left align-middle shadow-xl transition-all animate-bounce-in">
              <div className="flex items-center justify-between mb-8">
                <h3 className="text-2xl font-bold leading-6 text-gray-900 dark:text-white">
                    Yeni GÃ¶rev OluÅŸtur
                </h3>
                <button onClick={closeModal} className="p-2 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700"><X className="w-6 h-6 text-gray-500" /></button>
              </div>
              <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
                  <div>
                      <label className="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">GÃ¶rev BaÅŸlÄ±ÄŸÄ± *</label>
                      <input type="text" {...register('title', { required: 'BaÅŸlÄ±k zorunludur' })} className="modern-input" />
                      {errors.title && <p className="text-red-500 text-xs mt-1">{errors.title.message}</p>}
                  </div>
                  <div>
                      <label className="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">AÃ§Ä±klama</label>
                      <textarea {...register('description')} rows={4} className="modern-textarea"></textarea>
                  </div>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <div>
                          <label className="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">MÃ¼ÅŸteri *</label>
                          <select {...register('customer_id', { required: 'MÃ¼ÅŸteri seÃ§imi zorunludur' })} className="modern-select">
                              <option value="">MÃ¼ÅŸteri SeÃ§in</option>
                              {customers.map(c => <option key={c.id} value={c.id}>{c.first_name} {c.last_name}</option>)}
                          </select>
                          {errors.customer_id && <p className="text-red-500 text-xs mt-1">{errors.customer_id.message}</p>}
                      </div>
                      <div>
                          <label className="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">BitiÅŸ Tarihi</label>
                          <input type="date" {...register('due_date')} className="modern-input" />
                      </div>
                  </div>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <div>
                          <label className="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">Ã–ncelik</label>
                          <select {...register('priority')} defaultValue="medium" className="modern-select">
                              <option value="low">DÃ¼ÅŸÃ¼k</option>
                              <option value="medium">Orta</option>
                              <option value="high">YÃ¼ksek</option>
                          </select>
                      </div>
                  </div>
                  <div className="pt-6 flex justify-end space-x-4">
                      <button type="button" onClick={closeModal} className="modern-button-secondary">Ä°ptal</button>
                      <button type="submit" className="modern-button-primary">GÃ¶revi OluÅŸtur</button>
                  </div>
              </form>
          </div>
        </div>
      )}
    </div>
  );
};
